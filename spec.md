# ペンライト BLEプロトコル仕様書

## 1. 概要

本仕様書は、RGBW LED搭載ペンライトのBluetooth Low Energy (BLE) 通信プロトコルを定義する。

### 1.1 主な機能

- 20個のカラープリセットの保存・読み出し
- リアルタイムカラープレビュー機能
- 本体ボタンによるプリセット切り替え
- プレビュータイムアウト機能（30秒）

### 1.2 LED構成

- R（赤）、G（緑）、B（青）、W（白）の4チャンネル
- 各チャンネル8bit PWM制御（0-255）

---

## 2. BLE GATT サービス定義

### 2.1 サービス

| 項目 | 値 |
|------|-----|
| サービス名 | Penlight Control Service |
| UUID | `0000ff00-0000-1000-8000-00805f9b34fb` |

### 2.2 キャラクタリスティック一覧

| 名称 | UUID | Property | サイズ | 説明 |
|------|------|----------|--------|------|
| Preset Write | `0000ff01-...` | Write | 5 bytes | プリセット設定を書き込む |
| Preset Read | `0000ff02-...` | Read, Write | 1/4 bytes | プリセット読み出し |
| Preview Color | `0000ff03-...` | Write | 4 bytes | 一時的にプレビュー表示 |
| Current Preset | `0000ff04-...` | Read, Notify | 1 byte | 現在選択中のプリセット番号 |
| Exit Preview | `0000ff05-...` | Write | 1 byte | プレビューモード終了 |
| Battery Level | `0000ff06-...` | Read, Notify | 1 byte | バッテリー残量（0-100%）|

---

## 3. データフォーマット

### 3.1 Preset Write（プリセット書き込み）

**データサイズ**: 5 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4]
[Preset] [R PWM]  [G PWM]  [B PWM]  [W PWM]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | R PWM | 0-255 | 赤LED PWM値 |
| 2 | G PWM | 0-255 | 緑LED PWM値 |
| 3 | B PWM | 0-255 | 青LED PWM値 |
| 4 | W PWM | 0-255 | 白LED PWM値 |

**例**:

```
[0x00][0xFF][0x00][0x00][0x00]  // プリセット0: 赤(255,0,0,0)
[0x01][0x00][0x00][0x00][0xFF]  // プリセット1: 白(0,0,0,255)
[0x02][0xFF][0xFF][0x00][0x80]  // プリセット2: 黄色+白(255,255,0,128)
```

**動作**:

- 指定されたプリセット番号にRGBW値を保存
- 不揮発性メモリ（EEPROM/Flash）に保存される
- 電源OFF後も保持される

---

### 3.2 Preset Read（プリセット読み出し）

**書き込みデータサイズ**: 1 byte

```
[Byte 0]
[Preset]  // 読み出したいプリセット番号（0-19）
```

**読み出しデータサイズ**: 4 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3]
[R PWM]  [G PWM]  [B PWM]  [W PWM]
```

**例**:

```
書き込み: [0x05]  // プリセット5番を要求
読み出し: [0xFF][0x00][0xFF][0x00]  // R=255, G=0, B=255, W=0
```

---

### 3.3 Preview Color（カラープレビュー）

**データサイズ**: 4 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3]
[R PWM]  [G PWM]  [B PWM]  [W PWM]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | R PWM | 0-255 | 赤LED PWM値 |
| 1 | G PWM | 0-255 | 緑LED PWM値 |
| 2 | B PWM | 0-255 | 青LED PWM値 |
| 3 | W PWM | 0-255 | 白LED PWM値 |

**例**:

```
[0x00][0xFF][0x00][0x40]  // R=0, G=255, B=0, W=64
```

**動作**:

- 受信した色を即座にLEDに反映
- 不揮発性メモリには保存されない
- プレビューモードに遷移
- タイムアウトタイマー（30秒）が開始される

---

### 3.4 Current Preset（現在のプリセット）

**データサイズ**: 1 byte

```
[Byte 0]
[Preset]  // 現在選択中のプリセット番号（0-19）
```

**動作**:

- Read: 現在選択中のプリセット番号を取得
- Notify: ボタン押下時に自動通知

---

### 3.5 Exit Preview（プレビュー終了）

**データサイズ**: 1 byte

```
[Byte 0]
[Command]  // 0x01: プレビュー終了
```

**動作**:

- プレビューモードを終了
- 現在のプリセット番号の色に戻る
- タイムアウトタイマーをリセット

---

### 3.6 Battery Level（バッテリー残量）

**データサイズ**: 1 byte

```
[Byte 0]
[Level]  // バッテリー残量（0-100%）
```

**動作**:

- Read: 現在のバッテリー残量を取得
- Notify: 残量が変化したときに通知（任意実装）

---

## 4. 動作モード

### 4.1 通常モード

- 現在のプリセット番号に対応する色を表示
- ボタン押下でプリセット番号をインクリメント（0→1→...→19→0）
- プリセット変更時にCurrent Presetを通知

### 4.2 プレビューモード

- Preview Color受信時に遷移
- 受信した色を一時的に表示
- 30秒のタイムアウトタイマーが動作
- 以下のいずれかで通常モードに復帰:
  - Exit Preview受信
  - ボタン押下
  - 30秒のタイムアウト

---

## 5. 状態遷移図

```
           起動
            ↓
      [通常モード]
       (プリセット0)
            ↓
    ┌───────┴───────┐
    │               │
ボタン押下    Preview Color受信
    │               │
    ↓               ↓
[次のプリセット]  [プレビューモード]
    │               │
    │          ┌────┼────┐
    │          │    │    │
    │      Exit  ボタン  30秒
    │     Preview 押下  経過
    │          │    │    │
    └──────────┴────┴────┘
            ↓
      [通常モード]
```

---

## 6. 使用フロー例

### 6.1 初期設定フロー

```
1. アプリからBLE接続
2. プリセット0-19を順次書き込み
   Preset Write: [0x00][0xFF][0x00][0x00][0x00]  // 赤
   Preset Write: [0x01][0x00][0xFF][0x00][0x00]  // 緑
   ...
   Preset Write: [0x13][0x00][0x00][0x00][0xFF]  // 白
3. 接続解除
```

### 6.2 プレビュー・保存フロー

```
1. アプリからBLE接続
2. カラーピッカーでスライド操作
   → Preview Color: [0x80][0x40][0x20][0x10]  // リアルタイム反映
   → Preview Color: [0x90][0x50][0x30][0x20]  // 連続送信
   → Preview Color: [0xFF][0x80][0x00][0x00]  // 最終色
3. 「保存」ボタン押下
   → Preset Write: [0x05][0xFF][0x80][0x00][0x00]  // プリセット5に保存
   → Exit Preview: [0x01]  // 通常モードに戻る
```

### 6.3 キャンセルフロー

```
1. プレビュー中
2. 「キャンセル」ボタン押下
   → Exit Preview: [0x01]  // 元のプリセットに戻る
```

### 6.4 実使用フロー（コンサート会場など）

```
1. 電源ON → プリセット0で点灯
2. ボタン押下 → プリセット1に変更
3. ボタン押下 → プリセット2に変更
4. ...
5. ボタン押下（プリセット19） → プリセット0に戻る
```

---

## 7. タイムアウト仕様

### 7.1 プレビュータイムアウト

| 項目 | 値 |
|------|-----|
| タイムアウト時間 | 30秒 |
| 起点 | Preview Color受信時 |
| 動作 | 通常モード（現在のプリセット）に復帰 |
| リセット条件 | 新たなPreview Color受信 |

### 7.2 タイマー動作

```
Preview Color受信
    ↓
タイマー開始（30秒）
    ↓
    ├→ 30秒以内に新しいPreview Color受信
    │       ↓
    │   タイマーリセット＆再スタート
    │
    └→ 30秒経過
            ↓
        通常モードに復帰
```

---

## 8. 実装上の注意事項

### 8.1 マイコン側

1. **不揮発性メモリ管理**
   - プリセットは20個分（20 × 4 bytes = 80 bytes）確保
   - EEPROM/Flash書き込み回数制限に注意
   - 書き込み前に変更チェック推奨

2. **プレビューモード管理**
   - プレビューフラグとタイマーを実装
   - ボタン割り込み時にプレビューモードをチェック
   - タイムアウト処理を非同期で実装

3. **PWM出力**
   - 各チャンネルを独立制御
   - ちらつき防止のため十分な周波数設定（推奨: 1kHz以上）

4. **電力管理**
   - 全LEDフル点灯時の消費電流に注意
   - バッテリー残量監視を実装

### 8.2 アプリ側

1. **接続管理**
   - BLE接続確立後、サービス・キャラクタリスティック検索
   - 接続タイムアウト処理

2. **プレビュー送信**
   - カラーピッカー操作中は適度な間隔で送信（推奨: 50-100ms）
   - 連続送信時はBLEキューオーバーフローに注意

3. **Current Preset通知**
   - ボタン操作を検知するためNotifyを有効化
   - 受信したプリセット番号でUIを更新

4. **エラーハンドリング**
   - BLE接続切断時の処理
   - 書き込み失敗時のリトライ

---

## 9. 拡張仕様案（将来実装）

- **パターンモード**: 点滅、グラデーション、レインボーなど
- **グループ制御**: 複数のペンライトを同時制御
- **OTA更新**: ファームウェアの無線アップデート
- **ユーザー名設定**: 複数デバイス識別用

---

## 10. バージョン情報

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-10-13 | 初版作成 |
