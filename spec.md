# ペンライト BLEプロトコル仕様書

## 1. 概要

本仕様書は、RGBW LED搭載ペンライトのBluetooth Low Energy (BLE) 通信プロトコルを定義する。

### 1.1 主な機能

- 20個のカラープリセットの保存・読み出し
- リアルタイムカラープレビュー機能
- 本体ボタンによるプリセット切り替え
- プレビュータイムアウト機能（30秒）
- 5種類のエフェクトモード（固定色、レインボー、グラデーション、点滅）

### 1.2 LED構成

- R（赤）、G（緑）、B（青）、W（白）の4チャンネル
- 各チャンネル8bit PWM制御（0-255）

---

## 2. BLE GATT サービス定義

### 2.1 サービス

| 項目 | 値 |
|------|-----|
| サービス名 | Penlight Control Service |
| UUID | `0000ff00-0000-1000-8000-00805f9b34fb` |

### 2.2 キャラクタリスティック一覧

| 名称 | UUID | Property | サイズ | 説明 |
|------|------|----------|--------|------|
| Preset Write | `0000ff01-...` | Write | 2-11 bytes | プリセット設定を書き込む（エフェクトモード対応） |
| Preset Read | `0000ff02-...` | Read, Write | 1/10 bytes | プリセット読み出し（エフェクトモード対応） |
| Preview Color | `0000ff03-...` | Write | 1-10 bytes | 一時的にプレビュー表示（エフェクトモード対応） |
| Current Preset | `0000ff04-...` | Read, Notify | 1 byte | 現在選択中のプリセット番号 |
| Exit Preview | `0000ff05-...` | Write | 1 byte | プレビューモード終了 |
| Battery Level | `0000ff06-...` | Read, Notify | 1 byte | バッテリー残量（0-100%）|

---

## 3. データフォーマット

### 3.1 エフェクトモード定義

| モードID | モード名 | 説明 | データサイズ |
|---------|---------|------|-------------|
| 0x00 | 固定色 | 指定RGBWで固定表示 | 6 bytes |
| 0x01 | レインボー | 虹色が循環 | 4 bytes |
| 0x02 | グラデーション | 2色間を往復 | 11 bytes |
| 0x03 | 点滅 | オン/オフ繰り返し | 7 bytes |

### 3.2 Preset Write（プリセット書き込み）

#### 3.2.1 固定色モード（Mode 0x00）

**データサイズ**: 6 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4] [Byte 5]
[Preset] [Mode]   [R PWM]  [G PWM]  [B PWM]  [W PWM]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | Mode | 0x00 | 固定色モード |
| 2 | R PWM | 0-255 | 赤LED PWM値 |
| 3 | G PWM | 0-255 | 緑LED PWM値 |
| 4 | B PWM | 0-255 | 青LED PWM値 |
| 5 | W PWM | 0-255 | 白LED PWM値 |

**例**:

```
[0x00][0x00][0xFF][0x00][0x00][0x00]  // プリセット0: 固定色 赤(255,0,0,0)
[0x01][0x00][0x00][0x00][0x00][0xFF]  // プリセット1: 固定色 白(0,0,0,255)
```

#### 3.2.2 レインボーモード（Mode 0x01）

**データサイズ**: 4 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3]
[Preset] [Mode]   [Speed]  [Brightness]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | Mode | 0x01 | レインボーモード |
| 2 | Speed | 1-255 | 変化速度（1:遅い 〜 255:速い） |
| 3 | Brightness | 0-255 | 全体の明るさ |

**例**:

```
[0x02][0x01][0x80][0xFF]  // プリセット2: レインボー 中速、最大輝度
```

**動作**:

- HSVカラースペースでHue値を0〜360度で循環
- Speedパラメータで循環速度を制御
- Brightnessで全体の明るさを調整

#### 3.2.3 グラデーションモード（Mode 0x02）

**データサイズ**: 11 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4] [Byte 5] [Byte 6] [Byte 7] [Byte 8] [Byte 9] [Byte 10]
[Preset] [Mode]   [R1]     [G1]     [B1]     [W1]     [R2]     [G2]     [B2]     [W2]     [Speed]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | Mode | 0x02 | グラデーションモード |
| 2-5 | Color1 RGBW | 0-255 | 開始色のRGBW値 |
| 6-9 | Color2 RGBW | 0-255 | 終了色のRGBW値 |
| 10 | Speed | 1-255 | 変化速度 |

**例**:

```
[0x03][0x02][0xFF][0x00][0x00][0x00][0x00][0x00][0xFF][0x00][0x40]
// プリセット3: 赤→青のグラデーション、中低速
```

**動作**:

- Color1からColor2へ線形補間で変化
- Color2到達後、Color1へ戻る（往復）
- Speedパラメータで変化速度を制御

#### 3.2.4 点滅モード（Mode 0x03）

**データサイズ**: 7 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4] [Byte 5] [Byte 6]
[Preset] [Mode]   [R PWM]  [G PWM]  [B PWM]  [W PWM]  [Period]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | Mode | 0x03 | 点滅モード |
| 2-5 | Color RGBW | 0-255 | 点灯時のRGBW値 |
| 6 | Period | 1-255 | 点滅周期（単位: 100ms、1=100ms 〜 255=25.5秒） |

**例**:

```
[0x04][0x03][0xFF][0x00][0x00][0x00][0x0A]
// プリセット4: 赤色点滅、1秒周期（0.5秒ON/0.5秒OFF）
```

**動作**:

- 指定色で点灯/消灯を繰り返す
- ON/OFF時間はPeriod÷2で均等
- Period × 100ms = 1サイクル時間

---

### 3.4 Preset Read（プリセット読み出し）

**書き込みデータサイズ**: 1 byte

```
[Byte 0]
[Preset]  // 読み出したいプリセット番号（0-19）
```

**読み出しデータサイズ**: 可変（1-10 bytes、モードに依存）

書き込みでプリセット番号を指定後、読み出しで該当プリセットのデータを取得。
返されるデータフォーマットはモードによって異なる。

#### 3.4.1 固定色モード（Mode 0x00）の読み出し

**サイズ**: 5 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4]
[Mode]   [R PWM]  [G PWM]  [B PWM]  [W PWM]
```

**例**:

```
書き込み: [0x00]  // プリセット0番を要求
読み出し: [0x00][0xFF][0x00][0x00][0x00]  // 固定色モード、赤
```

#### 3.4.2 レインボーモード（Mode 0x01）の読み出し

**サイズ**: 3 bytes

```
[Byte 0] [Byte 1] [Byte 2]
[Mode]   [Speed]  [Brightness]
```

#### 3.4.3 グラデーションモード（Mode 0x02）の読み出し

**サイズ**: 10 bytes

```
[Byte 0] [Byte 1-4]  [Byte 5-8]  [Byte 9]
[Mode]   [Color1]    [Color2]    [Speed]
```

#### 3.4.4 点滅モード（Mode 0x03）の読み出し

**サイズ**: 6 bytes

```
[Byte 0] [Byte 1-4] [Byte 5]
[Mode]   [Color]    [Period]
```

---

### 3.5 Preview Color（カラープレビュー）

**データサイズ**: 可変（1-10 bytes、モードに依存）

Preview Colorは、Preset Writeと同じフォーマットを使用するが、プリセット番号を含まない。
各モードの先頭バイトがMode IDとなる。

**動作**:

- 受信したエフェクトを即座にLEDに反映
- 不揮発性メモリには保存されない
- プレビューモードに遷移
- タイムアウトタイマー（30秒）が開始される

#### 3.5.1 固定色モードのプレビュー

**データサイズ**: 5 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4]
[Mode]   [R PWM]  [G PWM]  [B PWM]  [W PWM]
```

**例**:

```
[0x00][0x00][0xFF][0x00][0x40]  // 固定色: R=0, G=255, B=0, W=64
```

#### 3.5.2 レインボーモードのプレビュー

**データサイズ**: 3 bytes

```
[Byte 0] [Byte 1] [Byte 2]
[Mode]   [Speed]  [Brightness]
```

**例**:

```
[0x01][0x80][0xFF]  // レインボー: 中速、最大輝度
```

#### 3.5.3 グラデーションモードのプレビュー

**データサイズ**: 10 bytes

```
[Byte 0] [Byte 1-4]  [Byte 5-8]  [Byte 9]
[Mode]   [Color1]    [Color2]    [Speed]
```

#### 3.5.4 点滅モードのプレビュー

**データサイズ**: 6 bytes

```
[Byte 0] [Byte 1-4] [Byte 5]
[Mode]   [Color]    [Period]
```

---

### 3.6 Current Preset（現在のプリセット）

**データサイズ**: 1 byte

```
[Byte 0]
[Preset]  // 現在選択中のプリセット番号（0-19）
```

**動作**:

- Read: 現在選択中のプリセット番号を取得
- Notify: ボタン押下時に自動通知

---

### 3.7 Exit Preview（プレビュー終了）

**データサイズ**: 1 byte

```
[Byte 0]
[Command]  // 0x01: プレビュー終了
```

**動作**:

- プレビューモードを終了
- 現在のプリセット番号のエフェクトに戻る
- タイムアウトタイマーをリセット

---

### 3.8 Battery Level（バッテリー残量）

**データサイズ**: 1 byte

```
[Byte 0]
[Level]  // バッテリー残量（0-100%）
```

**動作**:

- Read: 現在のバッテリー残量を取得
- Notify: 残量が変化したときに通知（任意実装）

---

## 4. 動作モード

### 4.1 通常モード

- 現在のプリセット番号に対応するエフェクトを表示
- エフェクトの種類に応じて自動的にアニメーション実行
- ボタン押下でプリセット番号をインクリメント（0→1→...→19→0）
- プリセット変更時にCurrent Presetを通知

### 4.2 プレビューモード

- Preview Color受信時に遷移
- 受信したエフェクトを一時的に表示
- エフェクトの種類に応じてアニメーション実行
- 30秒のタイムアウトタイマーが動作
- 以下のいずれかで通常モードに復帰:
  - Exit Preview受信
  - ボタン押下
  - 30秒のタイムアウト

### 4.3 エフェクト実行

各エフェクトモードは、通常モード・プレビューモード双方で動作する：

- **固定色**: 指定されたRGBW値で点灯（アニメーションなし）
- **レインボー**: HSVカラースペースで連続的に色相を変化
- **グラデーション**: 2色間を滑らかに往復
- **点滅**: 指定色とOFFを周期的に切り替え

---

## 5. 状態遷移図

```
           起動
            ↓
      [通常モード]
       (プリセット0)
            ↓
    ┌───────┴───────┐
    │               │
ボタン押下    Preview Color受信
    │               │
    ↓               ↓
[次のプリセット]  [プレビューモード]
    │               │
    │          ┌────┼────┐
    │          │    │    │
    │      Exit  ボタン  30秒
    │     Preview 押下  経過
    │          │    │    │
    └──────────┴────┴────┘
            ↓
      [通常モード]
```

---

## 6. 使用フロー例

### 6.1 初期設定フロー

```
1. アプリからBLE接続
2. プリセット0-19を順次書き込み
   Preset Write: [0x00][0x00][0xFF][0x00][0x00][0x00]  // プリセット0: 固定色 赤
   Preset Write: [0x01][0x00][0x00][0xFF][0x00][0x00]  // プリセット1: 固定色 緑
   Preset Write: [0x02][0x01][0x80][0xFF]              // プリセット2: レインボー
   Preset Write: [0x03][0x02][0xFF][0x00][0x00][0x00][0x00][0x00][0xFF][0x00][0x40]
                                                        // プリセット3: 赤→青グラデーション
   ...
3. 接続解除
```

### 6.2 固定色プレビュー・保存フロー

```
1. アプリからBLE接続
2. カラーピッカーでスライド操作
   → Preview Color: [0x00][0x80][0x40][0x20][0x10]  // 固定色プレビュー
   → Preview Color: [0x00][0x90][0x50][0x30][0x20]  // 連続送信
   → Preview Color: [0x00][0xFF][0x80][0x00][0x00]  // 最終色
3. 「保存」ボタン押下
   → Preset Write: [0x05][0x00][0xFF][0x80][0x00][0x00]  // プリセット5に保存
   → Exit Preview: [0x01]  // 通常モードに戻る
```

### 6.3 エフェクトプレビュー・保存フロー

```
1. アプリでレインボーエフェクトを選択
2. スピードと輝度を調整
   → Preview Color: [0x01][0x40][0x80]  // レインボープレビュー、低速、中輝度
   → Preview Color: [0x01][0x80][0xFF]  // スピード変更
3. 「保存」ボタン押下
   → Preset Write: [0x0A][0x01][0x80][0xFF]  // プリセット10に保存
   → Exit Preview: [0x01]
```

### 6.4 キャンセルフロー

```
1. プレビュー中
2. 「キャンセル」ボタン押下
   → Exit Preview: [0x01]  // 元のプリセット（エフェクト）に戻る
```

### 6.5 実使用フロー（コンサート会場など）

```
1. 電源ON → プリセット0で点灯（固定色 赤）
2. ボタン押下 → プリセット1に変更（固定色 緑）
3. ボタン押下 → プリセット2に変更（レインボーエフェクト開始）
4. ボタン押下 → プリセット3に変更（グラデーションエフェクト開始）
5. ...
6. ボタン押下（プリセット19） → プリセット0に戻る
```

---

## 7. タイムアウト仕様

### 7.1 プレビュータイムアウト

| 項目 | 値 |
|------|-----|
| タイムアウト時間 | 30秒 |
| 起点 | Preview Color受信時 |
| 動作 | 通常モード（現在のプリセット）に復帰 |
| リセット条件 | 新たなPreview Color受信 |

### 7.2 タイマー動作

```
Preview Color受信
    ↓
タイマー開始（30秒）
    ↓
    ├→ 30秒以内に新しいPreview Color受信
    │       ↓
    │   タイマーリセット＆再スタート
    │
    └→ 30秒経過
            ↓
        通常モードに復帰
```

---

## 8. 実装上の注意事項

### 8.1 マイコン側

1. **不揮発性メモリ管理**
   - プリセットデータは可変長（最大11 bytes/プリセット）
   - 20個分で最大 220 bytes 確保（実際は各モードで異なる）
   - 各プリセットの先頭にMode ID + データ長を記録推奨
   - EEPROM/Flash書き込み回数制限に注意
   - 書き込み前に変更チェック推奨

2. **プレビューモード管理**
   - プレビューフラグとタイマーを実装
   - ボタン割り込み時にプレビューモードをチェック
   - タイムアウト処理を非同期で実装
   - エフェクト実行中も割り込み可能にする

3. **PWM出力**
   - 各チャンネルを独立制御
   - ちらつき防止のため十分な周波数設定（推奨: 1kHz以上）
   - エフェクト更新は10-50ms間隔を推奨

4. **電力管理**
   - 全LEDフル点灯時の消費電流に注意
   - レインボー/グラデーションモードでは平均電流が変動
   - バッテリー残量監視を実装

5. **エフェクト実装**
   - レインボーモード: HSV→RGB変換関数を実装
   - グラデーションモード: 線形補間を実装
   - 各エフェクトは非同期タイマーで更新
   - モード切り替え時はエフェクトタイマーをリセット

### 8.2 アプリ側

1. **接続管理**
   - BLE接続確立後、サービス・キャラクタリスティック検索
   - 接続タイムアウト処理

2. **プレビュー送信**
   - 固定色: カラーピッカー操作中は適度な間隔で送信（推奨: 50-100ms）
   - エフェクト: パラメータ変更時に即座に送信
   - 連続送信時はBLEキューオーバーフローに注意

3. **Current Preset通知**
   - ボタン操作を検知するためNotifyを有効化
   - 受信したプリセット番号でUIを更新
   - プリセット読み出しでエフェクト情報を取得してUI反映

4. **エラーハンドリング**
   - BLE接続切断時の処理
   - 書き込み失敗時のリトライ
   - 可変長データの送受信エラー処理

5. **UI実装**
   - モード選択UI（固定色/レインボー/グラデーション/点滅）
   - 各モード専用のパラメータ調整UI
   - プレビュー表示の視覚的フィードバック

---

## 9. 拡張仕様案（将来実装）

- **追加エフェクトモード**: ストロボ、パルス、ウェーブなど
- **音楽連動**: マイク入力でビート検出、音楽同期
- **グループ制御**: 複数のペンライトを同時制御
- **OTA更新**: ファームウェアの無線アップデート
- **ユーザー名設定**: 複数デバイス識別用
- **カスタムエフェクト**: ユーザー定義のアニメーションパターン

---

## 10. バージョン情報

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-10-13 | 初版作成 |
| 2.0 | 2025-10-25 | エフェクトモード機能追加（固定色/レインボー/グラデーション/点滅）<br>Preset Write/Read/Preview Colorを可変長データに拡張 |
