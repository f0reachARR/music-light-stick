# ペンライト BLE通信プロトコル仕様書

## 概要

本仕様書は、RGBW LED搭載ペンライトのBluetooth Low Energy (BLE) 通信プロトコルを定義する。

### 主な機能

- 20個のカラープリセットの保存・読み出し
- リアルタイムカラープレビュー機能
- 本体ボタンによるプリセット切り替え
- プレビュータイムアウト機能（30秒）
- 5種類のエフェクトモード（固定色、レインボー、グラデーション、点滅）

### LED構成

- R（赤）、G（緑）、B（青）、W（白）の4チャンネル
- 各チャンネル8bitでRGB値 + 白色輝度を制御
  - ガンマ補正を考慮したPWM制御

---

## BLE GATT サービス定義

### サービス

| 項目 | 値 |
|------|-----|
| サービス名 | Penlight Control Service |
| UUID | `0000ff00-0000-1000-8000-00805f9b34fb` |

### キャラクタリスティック一覧

| 名称 | UUID | Property | サイズ | 説明 |
|------|------|----------|--------|------|
| Preset Write | `0000ff01-...` | Write | 2-11 bytes | プリセット設定を書き込む |
| Preset Read | `0000ff02-...` | Read, Write | 1/10 bytes | プリセット読み出し |
| Preset Save | `0000ff03-...` | Write | 0 bytes | プリセットを不揮発性メモリに保存する |
| Preview Color | `0000ff04-...` | Write | 1-10 bytes | 一時的にプレビュー表示 |
| Current Preset | `0000ff05-...` | Read, Notify | 1 byte | 現在選択中のプリセット番号 |
| Exit Preview | `0000ff06-...` | Write | 1 byte | プレビューモード終了 |
| Battery Level | `0000ff07-...` | Read, Notify | 1 byte | バッテリー残量（0-100%）|

---

## データフォーマット

### エフェクトモード定義

| モードID | モード名 | 説明 | データサイズ |
|---------|---------|------|-------------|
| 0x00 | 固定色 | 指定RGBWで固定表示 | 6 bytes |
| 0x01 | レインボー | 虹色が循環 | 4 bytes |
| 0x02 | グラデーション | 2色間を往復 | 11 bytes |
| 0x03 | 点滅 | オン/オフ繰り返し | 7 bytes |

### Preset Write（プリセット書き込み）

#### 固定色モード（Mode 0x00）

**データサイズ**: 6 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4] [Byte 5]
[Preset] [Mode]   [R PWM]  [G PWM]  [B PWM]  [W PWM]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | Mode | 0x00 | 固定色モード |
| 2 | R PWM | 0-255 | 赤LED PWM値 |
| 3 | G PWM | 0-255 | 緑LED PWM値 |
| 4 | B PWM | 0-255 | 青LED PWM値 |
| 5 | W PWM | 0-255 | 白LED PWM値 |

**例**:

```
[0x00][0x00][0xFF][0x00][0x00][0x00]  // プリセット0: 固定色 赤(255,0,0,0)
[0x01][0x00][0x00][0x00][0x00][0xFF]  // プリセット1: 固定色 白(0,0,0,255)
```

#### レインボーモード（Mode 0x01）

**データサイズ**: 4 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3]
[Preset] [Mode]   [Speed]  [Brightness]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | Mode | 0x01 | レインボーモード |
| 2 | Speed | 1-255 | 変化速度（1:遅い 〜 255:速い） |
| 3 | Brightness | 0-255 | 全体の明るさ |

**例**:

```
[0x02][0x01][0x80][0xFF]  // プリセット2: レインボー 中速、最大輝度
```

#### グラデーションモード（Mode 0x02）

**データサイズ**: 11 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4] [Byte 5] [Byte 6] [Byte 7] [Byte 8] [Byte 9] [Byte 10]
[Preset] [Mode]   [R1]     [G1]     [B1]     [W1]     [R2]     [G2]     [B2]     [W2]     [Speed]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | Mode | 0x02 | グラデーションモード |
| 2-5 | Color1 RGBW | 0-255 | 開始色のRGBW値 |
| 6-9 | Color2 RGBW | 0-255 | 終了色のRGBW値 |
| 10 | Speed | 1-255 | 変化速度 |

**例**:

```
[0x03][0x02][0xFF][0x00][0x00][0x00][0x00][0x00][0xFF][0x00][0x40]
// プリセット3: 赤→青のグラデーション、中低速
```

#### 点滅モード（Mode 0x03）

**データサイズ**: 7 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4] [Byte 5] [Byte 6]
[Preset] [Mode]   [R PWM]  [G PWM]  [B PWM]  [W PWM]  [Period]
```

| Byte | 名称 | 範囲 | 説明 |
|------|------|------|------|
| 0 | Preset Number | 0-19 | プリセット番号 |
| 1 | Mode | 0x03 | 点滅モード |
| 2-5 | Color RGBW | 0-255 | 点灯時のRGBW値 |
| 6 | Period | 1-255 | 点滅周期（単位: 100ms、1=100ms 〜 255=25.5秒） |

**例**:

```
[0x04][0x03][0xFF][0x00][0x00][0x00][0x0A]
// プリセット4: 赤色点滅、1秒周期（0.5秒ON/0.5秒OFF）
```

---

### Preset Read（プリセット読み出し）

**書き込みデータサイズ**: 1 byte

```
[Byte 0]
[Preset]  // 読み出したいプリセット番号（0-19）
```

**読み出しデータサイズ**: 可変（1-10 bytes、モードに依存）

書き込みでプリセット番号を指定後、読み出しで該当プリセットのデータを取得。
返されるデータフォーマットはモードによって異なる。

#### 固定色モード（Mode 0x00）の読み出し

**サイズ**: 5 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4]
[Mode]   [R PWM]  [G PWM]  [B PWM]  [W PWM]
```

**例**:

```
書き込み: [0x00]  // プリセット0番を要求
読み出し: [0x00][0xFF][0x00][0x00][0x00]  // 固定色モード、赤
```

#### レインボーモード（Mode 0x01）の読み出し

**サイズ**: 3 bytes

```
[Byte 0] [Byte 1] [Byte 2]
[Mode]   [Speed]  [Brightness]
```

#### グラデーションモード（Mode 0x02）の読み出し

**サイズ**: 10 bytes

```
[Byte 0] [Byte 1-4]  [Byte 5-8]  [Byte 9]
[Mode]   [Color1]    [Color2]    [Speed]
```

#### 点滅モード（Mode 0x03）の読み出し

**サイズ**: 6 bytes

```
[Byte 0] [Byte 1-4] [Byte 5]
[Mode]   [Color]    [Period]
```

---

### Preset Save（プリセット保存）

**データサイズ**: 0 bytes

すべてのプリセットデータを不揮発性メモリに保存する。

### Preview Color（カラープレビュー）

**データサイズ**: 可変（1-10 bytes、モードに依存）

Preview Colorは、Preset Writeと同じフォーマットを使用するが、プリセット番号を含まない。
各モードの先頭バイトがMode IDとなる。

#### 固定色モードのプレビュー

**データサイズ**: 5 bytes

```
[Byte 0] [Byte 1] [Byte 2] [Byte 3] [Byte 4]
[Mode]   [R PWM]  [G PWM]  [B PWM]  [W PWM]
```

**例**:

```
[0x00][0x00][0xFF][0x00][0x40]  // 固定色: R=0, G=255, B=0, W=64
```

#### レインボーモードのプレビュー

**データサイズ**: 3 bytes

```
[Byte 0] [Byte 1] [Byte 2]
[Mode]   [Speed]  [Brightness]
```

**例**:

```
[0x01][0x80][0xFF]  // レインボー: 中速、最大輝度
```

#### グラデーションモードのプレビュー

**データサイズ**: 10 bytes

```
[Byte 0] [Byte 1-4]  [Byte 5-8]  [Byte 9]
[Mode]   [Color1]    [Color2]    [Speed]
```

#### 点滅モードのプレビュー

**データサイズ**: 6 bytes

```
[Byte 0] [Byte 1-4] [Byte 5]
[Mode]   [Color]    [Period]
```

---

### Current Preset（現在のプリセット）

**データサイズ**: 1 byte

```
[Byte 0]
[Preset]  // 現在選択中のプリセット番号（0-19）
```

**動作**:

- Read: 現在選択中のプリセット番号を取得
- Notify: ボタン押下時に自動通知

---

### Exit Preview（プレビュー終了）

**データサイズ**: 1 byte

```
[Byte 0]
[Command]  // 0x01: プレビュー終了
```

**動作**:

- プレビューモードを終了
- 現在のプリセット番号のエフェクトに戻る
- タイムアウトタイマーをリセット

---

### Battery Level（バッテリー残量）

**データサイズ**: 1 byte

```
[Byte 0]
[Level]  // バッテリー残量（0-100%）
```

**動作**:

- Read: 現在のバッテリー残量を取得
- Notify: 残量が変化したときに通知（任意実装）

---

## 使用フロー例

### 初期設定フロー

```
1. アプリからBLE接続
2. プリセット0-19を順次書き込み
   Preset Write: [0x00][0x00][0xFF][0x00][0x00][0x00]  // プリセット0: 固定色 赤
   Preset Write: [0x01][0x00][0x00][0xFF][0x00][0x00]  // プリセット1: 固定色 緑
   Preset Write: [0x02][0x01][0x80][0xFF]              // プリセット2: レインボー
   Preset Write: [0x03][0x02][0xFF][0x00][0x00][0x00][0x00][0x00][0xFF][0x00][0x40]
                                                        // プリセット3: 赤→青グラデーション
   ...
3. 接続解除
```

### 固定色プレビュー・保存フロー

```
1. アプリからBLE接続
2. カラーピッカーでスライド操作
   → Preview Color: [0x00][0x80][0x40][0x20][0x10]  // 固定色プレビュー
   → Preview Color: [0x00][0x90][0x50][0x30][0x20]  // 連続送信
   → Preview Color: [0x00][0xFF][0x80][0x00][0x00]  // 最終色
3. 「保存」ボタン押下
   → Preset Write: [0x05][0x00][0xFF][0x80][0x00][0x00]  // プリセット5に保存
   → Exit Preview: [0x01]  // 通常モードに戻る
```

### エフェクトプレビュー・保存フロー

```
1. アプリでレインボーエフェクトを選択
2. スピードと輝度を調整
   → Preview Color: [0x01][0x40][0x80]  // レインボープレビュー、低速、中輝度
   → Preview Color: [0x01][0x80][0xFF]  // スピード変更
3. 「保存」ボタン押下
   → Preset Write: [0x0A][0x01][0x80][0xFF]  // プリセット10に保存
   → Exit Preview: [0x01]
```

### キャンセルフロー

```
1. プレビュー中
2. 「キャンセル」ボタン押下
   → Exit Preview: [0x01]  // 元のプリセット（エフェクト）に戻る
```

---

## タイムアウト仕様

### プレビュータイムアウト

| 項目 | 値 |
|------|-----|
| タイムアウト時間 | 30秒 |
| 起点 | Preview Color受信時 |
| 動作 | 通常モード（現在のプリセット）に復帰 |
| リセット条件 | 新たなPreview Color受信 |

### タイマー動作

```
Preview Color受信
    ↓
タイマー開始（30秒）
    ↓
    ├→ 30秒以内に新しいPreview Color受信
    │       ↓
    │   タイマーリセット＆再スタート
    │
    └→ 30秒経過
            ↓
        通常モードに復帰
```

---

## アプリ側実装ガイドライン

### 接続管理

- BLE接続確立後、サービス・キャラクタリスティック検索
- 接続タイムアウト処理

### プレビュー送信

- 固定色: カラーピッカー操作中は適度な間隔で送信（推奨: 50-100ms）
- エフェクト: パラメータ変更時に即座に送信
- 連続送信時はBLEキューオーバーフローに注意

### Current Preset通知

- ボタン操作を検知するためNotifyを有効化
- 受信したプリセット番号でUIを更新
- プリセット読み出しでエフェクト情報を取得してUI反映

### エラーハンドリング

- BLE接続切断時の処理
- 書き込み失敗時のリトライ
- 可変長データの送受信エラー処理

### UI実装

- モード選択UI（固定色/レインボー/グラデーション/点滅）
- 各モード専用のパラメータ調整UI
- プレビュー表示の視覚的フィードバック

---

## バージョン情報

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-10-13 | 初版作成 |
| 2.0 | 2025-10-25 | エフェクトモード機能追加（固定色/レインボー/グラデーション/点滅）<br>Preset Write/Read/Preview Colorを可変長データに拡張 |
| 2.1 | 2026-02-08 | BLE通信仕様とMCU実装仕様を分離 |
