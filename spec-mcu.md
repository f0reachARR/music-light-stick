# ペンライト マイコン実装仕様書

## 概要

本仕様書は、RGBW LED搭載ペンライトのマイコン側実装仕様を定義する。
BLE通信プロトコルの詳細は [spec-ble.md](spec-ble.md) を参照。

また、本仕様書の内容はZephyr OSをベースに実装することを前提としている。

### ハードウェア構成

- R（赤）、G（緑）、B（青）、W（白）の4チャンネルLED
  - DeviceTree: pwm_led_r, pwm_led_g, pwm_led_b, pwm_led_w
- 各チャンネル8bit PWM制御（0-255）
- NEXTボタン、PREVボタン
  - DeviceTree: button_next, button_prev
- バッテリー電圧監視

---

## 動作モード

### 通常モード

- 現在のプリセット番号に対応するエフェクトを表示
- エフェクトの種類に応じて自動的にアニメーション実行
- ボタン押下でプリセット番号をインクリメント（0→1→...→19→0）
- プリセット変更時にCurrent Presetを通知
- NEXTボタン長押しでスリープモードへ移行

### プレビューモード

- Preview Color受信時に遷移
- 受信したエフェクトを一時的に表示
- エフェクトの種類に応じてアニメーション実行
- 30秒のタイムアウトタイマーが動作
- 以下のいずれかで通常モードに復帰:
  - Exit Preview受信
  - ボタン押下
  - 30秒のタイムアウト

### スリープモード

- NEXTボタン長押し（3秒以上）で移行
- LEDを消灯
- 低消費電力モードに遷移
  - NEXTボタンのみ復帰のため割り込み待機
- NEXTボタン長押しで通常モードに復帰
  - 復帰時にボタンの長押し判定を行う

---

## 状態遷移図

```
           起動
            ↓
      [通常モード]
       (プリセット0)
            ↓
    ┌───────┴───────┬─────────────┐
    │               │             │
ボタン押下    Preview Color受信   NEXT長押し
    │               │             │
    ↓               ↓             ↓
[次のプリセット]  [プレビューモード]  [スリープモード]
    │               │                  │
    │          ┌────┼────┐             │
    │          │    │    │         NEXTボタン
    │      Exit  ボタン  30秒        押下
    │     Preview 押下  経過          │
    │          │    │    │             │
    └──────────┴────┴────┴─────────────┘
            ↓
      [通常モード]
```

---

## エフェクト実装

### エフェクトモード一覧

| モードID | モード名 | アニメーション | 更新周期 |
|---------|---------|---------------|---------|
| 0x00 | 固定色 | なし | - |
| 0x01 | レインボー | HSV色相循環 | 10-50ms |
| 0x02 | グラデーション | 2色間線形補間 | 10-50ms |
| 0x03 | 点滅 | ON/OFF切替 | Period依存 |

### 固定色モード

- 指定されたRGBW値でLEDを点灯
- アニメーション処理不要

### レインボーモード

**アルゴリズム**:

1. HSVカラースペースでHue値を0〜360度で循環
2. Speedパラメータで循環速度を制御
3. Brightnessで全体の明るさを調整（V値として適用）
4. HSV→RGB変換後、PWM出力

**実装要件**:

- HSV→RGB変換関数の実装
- Hue更新間隔: `base_interval / Speed` （base_interval = 1000ms推奨）
- Hue増分: 1度/更新

### グラデーションモード

**アルゴリズム**:

1. Color1からColor2へ線形補間で変化
2. Color2到達後、Color1へ戻る（往復）
3. Speedパラメータで変化速度を制御

**実装要件**:

- 線形補間関数の実装: `color = color1 + (color2 - color1) * t` (t: 0.0〜1.0)
- 更新間隔: `base_interval / Speed`
- t増分: 0.01/更新（往復で方向反転）

### 点滅モード

**アルゴリズム**:

1. 指定色で点灯/消灯を繰り返す
2. ON/OFF時間はPeriod÷2で均等
3. Period × 100ms = 1サイクル時間

**実装要件**:

- タイマー割り込みまたはソフトタイマーで実装
- ON時間 = OFF時間 = (Period × 100ms) / 2

---

## 不揮発性メモリ管理

Zephyr OSのSettings APIを使用して不揮発性メモリにプリセットデータを保存・読み出し。

---

## PWM制御

### PWM仕様

| 項目 | 値 |
|------|-----|
| チャンネル数 | 4 (R, G, B, W) |
| 分解能 | 8bit (0-255)以上 |
| 周波数 | 1kHz以上（推奨） |

### 実装要件

- 各チャンネルを独立制御
- ちらつき防止のため十分な周波数設定
- エフェクト更新は10-50ms間隔を推奨
- 自然な色の反映のため、ガンマ補正を実装する

---

## ボタン制御

### ボタン仕様

| ボタン | 短押し | 長押し（3秒） |
|--------|--------|--------------|
| NEXT | 次のプリセットへ | スリープモードへ移行 |
| PREV | 前のプリセットへ | - |

### 実装要件

- デバウンス処理（推奨: 50ms）
- 長押し検出用タイマー
- 割り込みベースの実装を推奨
- プレビューモード中はボタン押下で通常モードに復帰

---

## プレビューモード管理

### 状態管理

- プレビューフラグ（bool）
- プレビュータイムアウトタイマー（30秒）
- プレビュー中のエフェクトデータ（一時保存）

### 実装要件

- Preview Color受信時にプレビューフラグをセット
- タイマー開始（30秒）
- ボタン割り込み時にプレビューモードをチェック
- タイムアウト処理を非同期で実装
- エフェクト実行中も割り込み可能にする
- プレビュー終了時は現在のプリセットに復帰

---

## 電力管理

### 消費電力考慮事項

- バッテリー残量監視を実装

### スリープモード

- NEXTボタン長押し（3秒）で移行
- LED消灯
- BLE広告停止し、Deep Sleepモードへ遷移
- NEXTボタンのGPIO割り込みで復帰、長押し検出で復帰

### バッテリー監視

- ADCによる電圧測定
- 残量を0-100%に変換
- BLEキャラクタリスティック経由で通知

---

## タイマー構成

| タイマー | 用途 | 周期 |
|---------|------|------|
| エフェクトタイマー | アニメーション更新 | 10-50ms |
| プレビュータイムアウト | プレビュー終了判定 | 30秒 |
| ボタンデバウンス | チャタリング防止 | 50ms |
| ボタン長押し検出 | スリープ移行判定 | 3秒 |
| バッテリー監視 | 残量更新 | 1分 |
